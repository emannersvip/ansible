---
# Tasks file for grafana
# This config is based on a Docker install

- name: 'Create Docker /opt/grafana subdirectories for Grafana'
  ansible.builtin.file:
    path: /opt/grafana
    state: directory
    mode: '0755'

- name: 'Create Docker /opt/grafana/etc subdirectories for Grafana'
  ansible.builtin.file:
    path: /opt/grafana/etc
    state: directory
    mode: '0755'

- name: 'Create Docker /opt/grafana/data subdirectories for Grafana'
  ansible.builtin.file:
    path: /opt/grafana/data
    state: directory
    mode: '0755'

- name: 'Grafana config file'
  ansible.builtin.template:
    src: 'grafana.ini.j2'
    dest: "/opt/grafana/etc/grafana.ini"
    owner: 'root'
    group: "{{ grafana_stack_admin_group }}"

- name: 'Grafana LDAP config file'
  ansible.builtin.template:
    src: 'ldap.toml.j2'
    dest: "/opt/grafana/etc/ldap.toml"
    owner: 'root'
    group: "{{ grafana_stack_admin_group }}"

- name: 'Grafana Docker Compose file'
  ansible.builtin.template:
    src: 'docker-compose.yml.j2'
    dest: "/opt/grafana/docker-compose.yml"
    owner: 'emanners'
    group: "{{ grafana_stack_admin_group }}"

# Grafana 8.4.6 is the last version compiled for docker image
# https://github.com/grafana/grafana/issues/47676
#- name: 'Docker_Pull Grafana Image'
#  community.docker.docker_image:
#    name: 'grafana/grafana-oss:8.4.6'
#    source: pull
#    pull:
#      platform: 'linux/arm64'

- name: 'Docker_Create the Grafana Container'
  community.docker.docker_container:
    name: 'grafana'
    image: 'grafana/grafana-oss:8.4.6'
    state: present
    ports:
      - "3000:3000/tcp"
    volumes:
      - '/opt/grafana/etc:/etc/grafana'
      - '/opt/grafana/data:/var/lib/grafana'
    user: '1001'
    restart_policy: 'unless-stopped'
    env:
      TZ: 'America/Chicago'
    platform: 'linux/arm64/v8'